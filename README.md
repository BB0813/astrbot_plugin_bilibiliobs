# B站UP主开播监测插件

一个用于监测指定B站UP主开播状态的AstrBot插件。当监控的UP主开始直播时，插件会自动发送通知。

## 功能特性

- 🔍 **实时监控**: 每60秒自动检查监控列表中UP主的直播状态
- 📢 **开播通知**: 检测到UP主开播时立即发送通知消息
- 👥 **多UP主支持**: 可同时监控多个UP主
- 📝 **状态查询**: 支持手动查询UP主当前直播状态
- 🛠️ **便捷管理**: 简单的命令即可添加/移除监控
- 💾 **数据持久化**: 监控配置自动保存，重启后恢复
- 🛡️ **异常处理**: 完善的错误处理和重试机制
- ⚡ **性能优化**: 智能缓存和异步处理
 - 📦 **批量查询**: 一次请求批量获取多个UP主状态，降低API压力
- 🧩 **可配置**: 支持检查间隔、最大监控数、通知开关
 - 🔔 **关播通知（可选）**: 支持UP主结束直播时的通知（默认开启）

## 安装依赖

插件需要以下Python库：

```bash
pip install aiohttp>=3.8.0
```

## 使用方法

### 基本命令

#### 1. 添加监控
```
/添加监控 <UP主UID>
```
例如：`/添加监控 123456`

#### 2. 移除监控
```
/移除监控 <UP主UID>
```
例如：`/移除监控 123456`

#### 3. 查看监控列表
```
/监控列表
```
显示当前所有监控的UP主及其直播状态

#### 4. 手动检查直播状态
```
/检查直播 <UP主UID>
```
例如：`/检查直播 123456`

#### 5. 查看插件状态
```
/插件状态
```
显示插件当前运行状态，包括HTTP会话、监控任务、监控数量等信息
 
#### 6. 开启通知
```
/开启通知
```
启用所有通知（开播与关播）

#### 7. 关闭通知
```
/关闭通知
```
关闭所有通知（开播与关播）

#### 8. 开启关播通知
```
/开启关播通知
```
仅开启关播通知（需同时开启总通知）

#### 9. 关闭关播通知
```
/关闭关播通知
```
仅关闭关播通知

### 配置项

可在插件配置中设置以下选项（对应 `_conf_schema.json`）：

- `check_interval`：监控检查间隔（秒），默认 60
- `max_monitors`：最大监控UP主数量，默认 50
- `enable_notifications`：是否启用开播通知，默认启用
- `enable_end_notifications`：是否启用关播通知，默认开启

示例：

```json
{
  "check_interval": 90,
  "max_monitors": 100,
  "enable_notifications": true
}
```

### 如何获取UP主UID

1. 打开UP主的B站主页
2. 查看URL中的数字部分，例如：`https://space.bilibili.com/123456` 中的 `123456` 就是UID
3. 或者在UP主主页按F12打开开发者工具，在Console中输入：`window.__INITIAL_STATE__.mid`

## 工作原理

1. **API调用**: 使用B站官方API `https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids` 获取直播状态 <mcreference link="https://lxb007981.github.io/bilibili-API-collect/live/info.html" index="1">1</mcreference>
2. **状态监控**: 后台任务每60秒检查一次所有监控UP主的直播状态
3. **变化检测**: 对比当前状态与缓存状态，检测开播事件
4. **通知发送**: 检测到开播时发送包含直播标题和链接的通知消息
5. **限流处理**: 检测到 429 限流后动态扩大发起间隔，并对单UID错误进行退避与跳过
6. **关播通知**: 当直播状态由1变为非1时（例如0），若开启关播通知则发送消息

## 注意事项

- 插件使用B站公开API，请合理使用避免频繁请求
- 监控检查间隔为60秒，可能存在1-2分钟的延迟
- 需要确保网络连接正常以获取直播状态
- UID必须是有效的B站用户ID
- 配置文件默认保存在用户目录：`~/.astrbot/bili_live_notice/monitor_config.json`，首次运行会自动迁移旧路径数据

## Handler详细说明

### 命令处理器 (Command Handlers)

#### 1. add_monitor - 添加监控处理器
- **触发命令**: `/添加监控`
- **功能**: 将指定UP主添加到监控列表
- **输入验证**: 
  - 检查参数数量（至少2个参数）
  - 验证UID格式（必须为纯数字）
  - 验证UP主存在性（通过API查询）
- **处理流程**:
  1. 解析命令参数
  2. 验证UID格式和有效性
  3. 调用B站API获取UP主信息
  4. 添加到监控字典和缓存
  5. 保存配置到文件
  6. 返回操作结果

#### 2. remove_monitor - 移除监控处理器
- **触发命令**: `/移除监控`
- **功能**: 从监控列表中移除指定UP主
- **输入验证**:
  - 检查参数数量
  - 验证UID格式
  - 检查UID是否在监控列表中
- **处理流程**:
  1. 解析命令参数
  2. 验证UID格式
  3. 从监控字典和缓存中删除
  4. 保存配置到文件
  5. 返回操作结果

#### 3. list_monitors - 监控列表处理器
- **触发命令**: `/监控列表`
- **功能**: 显示当前所有监控的UP主
- **处理流程**:
  1. 检查监控列表是否为空
  2. 遍历所有监控的UP主
  3. 获取每个UP主的当前状态
  4. 格式化输出列表信息

#### 4. check_live - 检查直播处理器
- **触发命令**: `/检查直播`
- **功能**: 手动检查指定UP主的直播状态
- **输入验证**:
  - 检查参数数量
  - 验证UID格式
  - 验证UP主存在性
- **处理流程**:
  1. 解析命令参数
  2. 验证UID格式和有效性
  3. 调用API获取实时状态
  4. 格式化状态信息
  5. 返回详细的直播信息

### 核心功能模块

#### 1. get_live_status - 状态获取模块
- **功能**: 通过B站API获取UP主直播状态
- **异常处理**:
  - 网络超时处理（10秒超时）
  - HTTP状态码处理（429限流、非200状态）
  - JSON解析错误处理
  - UID格式错误处理
- **返回数据**: 包含用户名、直播状态、房间ID、标题等信息

#### 2. monitor_live_status - 监控循环模块
- **功能**: 后台持续监控所有UP主的直播状态
- **特性**:
  - 可配置的检查间隔（默认60秒）
  - 连续错误计数和等待时间调整
  - 批量请求降低API压力
  - 单UID错误退避与跳过
  - 单个UP主错误不影响其他监控
  - 优雅的任务取消处理
- **异常处理**:
  - 区分处理asyncio.CancelledError和通用异常
  - 连续错误时增加等待时间
  - 429限流后动态调整间隔
  - 无监控对象时的等待逻辑

#### 3. 数据持久化模块
- **load_config**: 从JSON文件加载监控配置
- **save_config**: 将监控配置保存到JSON文件
- **特性**:
  - 自动创建配置文件
  - 异常安全的文件操作
  - 配置格式验证

## 技术实现

- **异步编程**: 使用`asyncio`和`aiohttp`实现高效的异步HTTP请求
- **状态缓存**: 本地缓存直播状态，减少不必要的API调用
- **错误处理**: 完善的异常处理机制，确保插件稳定运行
- **资源管理**: 正确的会话管理和任务清理
- **数据持久化**: JSON格式配置文件，支持插件重启后恢复
- **性能优化**: 智能重试机制和连接复用
- **批量优化**: 多UID批量查询，减少请求次数
- **限流应对**: 动态调整监控间隔与单UID退避

## 版本信息

- **版本**: 1.0.0
- **作者**: BB0813
- **仓库**: https://github.com/Binbim/astrbot_plugin_BiliBiliOBS
- **基于**: AstrBot_plugin_helloword

## 支持

如有问题或建议，请访问 [AstrBot帮助文档](https://astrbot.app) 或加入交流群。
